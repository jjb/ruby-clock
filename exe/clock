#!/usr/bin/env ruby

require 'ruby-clock'
RubyClock.detect_and_load_rails_app
require 'rufus_monkeypatch'
RubyClock.instance.listen_to_signals
RubyClock.instance.prepare_rake
RubyClock.instance.schedule.pause
RubyClock.instance.add_rails_executor_to_around_actions

begin
  load ARGV[0] || 'Clockfile'
rescue => clockfile_error
  if RubyClock.instance.on_error
    RubyClock.instance.on_error.call("An error has occured while parsing the clockfile", clockfile_error)
  end

  raise
end

RubyClock.instance.ensure_around_trigger_has_not_been_redefined
RubyClock.instance.freeze_around_actions
RubyClock.instance.run_jobs
