#!/usr/bin/env ruby

require 'ruby-clock'
require "ruby-clock/dsl"
RubyClock.detect_and_load_rails_app
require 'rufus_monkeypatch'
RubyClock.instance.listen_to_signals
RubyClock.instance.prepare_rake
RubyClock.instance.schedule.pause
RubyClock.instance.add_rails_executor_to_around_actions

check_syntax = false
if '--' == ARGV[0][0..1]
  case ARGV[0]
  when '--environment-and-syntax-check'
    check_syntax = true
  else
    raise 'unknown option'
  end
  if ARGV[1]
    clockfiles = ARGV[1..]
  else
    clockfiles = ['Clockfile']
  end
else
  if ARGV[0]
    clockfiles = ARGV[0..]
  else
    clockfiles = ['Clockfile']
  end
end

clockfiles.each do |clockfile|
  begin
    load clockfile
  rescue => clockfile_error
    if RubyClock.instance.on_error
      RubyClock.instance.on_error.call("An error has occured while parsing the clockfile #{clockfile}", clockfile_error)
    end

    raise
  end
end

RubyClock.instance.ensure_around_trigger_has_not_been_redefined
RubyClock.instance.freeze_around_actions

if check_syntax
  puts "✨ Environment & Syntax OK ✨"
else
  RubyClock.instance.run_jobs
end
