#!/usr/bin/env ruby

require 'ruby-clock'
require "ruby-clock/dsl"
RubyClock.detect_and_load_rails_app
require 'rufus_monkeypatch'
RubyClock.instance.listen_to_signals
RubyClock.instance.prepare_rake
RubyClock.instance.schedule.pause
RubyClock.instance.add_rails_executor_to_around_actions

if ARGV.count > 2
  puts <<~MESSAGE
    usage:
    bundle exec --environment-and-syntax-check clock/my_clockfile.rb
    bundle exec clock/my_clockfile.rb
  MESSAGE
  raise "too many arguments"
end

check_syntax = false
if '--' == ARGV[0][0..1]
  case ARGV[0]
  when '--environment-and-syntax-check'
    check_syntax = true
  else
    raise 'unknown option'
  end
  clockfile = ARGV[1] || 'Clockfile'
else
  clockfile = ARGV[0] || 'Clockfile'
end

begin
  load clockfile
rescue => clockfile_error
  if RubyClock.instance.on_error
    RubyClock.instance.on_error.call("An error has occured while parsing the clockfile", clockfile_error)
  end

  raise
end

RubyClock.instance.ensure_around_trigger_has_not_been_redefined
RubyClock.instance.freeze_around_actions

if check_syntax
  puts "✨ Environment & Syntax OK ✨"
else
  RubyClock.instance.run_jobs
end
