#!/usr/bin/env ruby

require 'ruby-clock'
RubyClock.detect_and_load_rails_app

require 'method_source'

class Rufus::Scheduler::Job
  def identifier
    @identifier ||= begin
      name || handler.source.split("\n").reject(&:empty?).grep_v(/#.*/)[-2].strip
    rescue
      begin
        source_location.join('-')
      rescue
        'error-calculating-job-identifier'
      end
    end
  end
end

RubyClock.instance.listen_to_signals
RubyClock.instance.prepare_rake
RubyClock.instance.schedule.pause

load ARGV[0] || 'Clockfile'
RubyClock.instance.add_rails_executor_to_around_actions

RubyClock.instance.freeze_around_actions

RubyClock.instance.run_jobs
